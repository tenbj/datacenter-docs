---
name: 文件转换技能
description: 用于将Excel、HTML文件转换为Markdown格式，支持合并单元格、图片提取，以及图片内容识别（流程图转Mermaid）
---

# 文件转换技能

## 概述

本技能提供文件格式转换能力，采用**两阶段处理流程**：

| 阶段  | 处理方     | 工作内容                            |
| ----- | ---------- | ----------------------------------- |
| 阶段1 | Python脚本 | 提取Excel内容、表格、图片           |
| 阶段2 | AI Agent   | 识别图片内容，将流程图转换为Mermaid |

> [!IMPORTANT]
> **脚本只负责提取，Agent负责识别**。脚本执行完成后，Agent必须检查输出的图片，对于流程图类图片进行Mermaid转换。

---

## 技能文件结构

```
file-converter/
├── SKILL.md                      # 本技能说明文件
└── scripts/
    └── convert_excel_to_md.py    # Excel转Markdown脚本
```

---

## 完整工作流程

### 步骤1：运行脚本提取内容

```powershell
python .agent\skills\file-converter\scripts\convert_excel_to_md.py "<输入Excel路径>" "<输出路径>"
```

### 步骤2：检查图片并进行AI识别

脚本执行完成后，Agent需要：

1. **查看输出的images目录**，找到所有提取的图片
2. **使用view_file工具查看图片**
3. **判断图片类型**：
   - 流程图 → 转换为Mermaid代码
   - 表格截图 → 转换为Markdown表格
   - 界面截图 → 添加文字描述
4. **更新对应的MD文件**，在图片引用下方添加识别结果

### 步骤3：更新MD文件

将识别结果插入到图片引用下方，格式如下：

```markdown
![流程图](images/xxx_image_1.png)

**Mermaid流程图：**

​```mermaid
flowchart LR
    ...
​```
```

---

## 输出规则

| Sheet数量 | 输出方式                                   |
| --------- | ------------------------------------------ |
| ≤10个     | 单个Markdown文件                           |
| >10个     | 创建文件夹，每个Sheet一个MD文件 + 索引文件 |

---

## 特殊场景处理

### 场景1：悬浮图片 + 文字组合

**描述**: 图片悬浮在单元格上方，与周围文字形成说明关系。

**处理方式**: 
- 阶段1（脚本）：提取图片，在对应位置插入图片引用
- 阶段2（Agent）：识别图片内容，添加Mermaid或文字描述

**输出示例**:
```markdown
## 流程说明

![流程图](images/流程图_image_1.png)

**Mermaid流程图：**

​```mermaid
flowchart LR
    用户((用户)) --> 创建请求[创建广告请求]
    创建请求 --> 审核{审核}
    审核 --> |通过| 执行[执行]
    审核 --> |拒绝| 结束[结束]
​```

上图展示了广告创建的完整流程，包括以下步骤：
1. 用户发起创建请求
2. 系统进行审核
3. 完成广告投放
```

---

### 场景2：单元格内嵌套图片

**描述**: 图片直接嵌入在表格单元格中。

**处理方式**: 
- 阶段1（脚本）：在对应单元格位置插入图片引用链接
- 阶段2（Agent）：如果是流程图，在表格外补充Mermaid

**输出示例**:
```markdown
| 步骤 | 操作说明     | 截图                       |
| ---- | ------------ | -------------------------- |
| 1    | 点击创建按钮 | ![步骤1](images/step1.png) |
| 2    | 填写表单信息 | ![步骤2](images/step2.png) |
| 3    | 提交审核     | ![步骤3](images/step3.png) |
```

---

### 场景3：合并单元格中的图片

**描述**: 图片位于跨行或跨列的合并单元格中。

**处理方式**: 
- 阶段1（脚本）：使用HTML表格，在合并单元格中嵌入图片引用
- 阶段2（Agent）：如果是流程图，在表格后补充Mermaid

**输出示例**:
```html
<table>
  <thead>
    <tr>
      <th>模块</th>
      <th>流程图</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td rowspan="3">广告模块</td>
      <td rowspan="3"><img src="images/ad_flow.png" alt="广告流程"></td>
      <td>步骤1：创建广告</td>
    </tr>
    <tr>
      <td>步骤2：设置预算</td>
    </tr>
    <tr>
      <td>步骤3：投放广告</td>
    </tr>
  </tbody>
</table>
```

---

### 场景4：隐藏Sheet

**描述**: Excel中存在隐藏的Sheet页。

**处理方式**: 
- 单文件模式：在标题后添加 `[隐藏]` 标识
- 多文件模式：在文件名中添加 `_隐藏` 后缀

**输出示例（单文件）**:
```markdown
## 配置数据 [隐藏]

| 配置项   | 值  |
| -------- | --- |
| 超时时间 | 30s |
| 重试次数 | 3   |
```

**输出示例（多文件）**:
```
output_folder/
├── 00_索引.md
├── 01_广告创建.md
├── 02_广告管理.md
├── 03_配置数据_隐藏.md    # 隐藏Sheet的文件名带标识
└── images/
```

---

### 场景5：多Sheet（>10个）分文件

**描述**: Excel包含超过10个Sheet。

**处理方式**: 创建输出文件夹，每个Sheet输出为独立MD文件，并生成索引文件。

**输出示例（目录结构）**:
```
广告业务流程_v1.0/
├── 00_索引.md                    # 索引文件，包含所有Sheet链接
├── 01_创建流程图.md
├── 02_广告创建涉及字段.md
├── ...
├── 15_配置数据_隐藏.md           # 隐藏Sheet
└── images/                       # 所有图片统一存放
```

**索引文件示例（00_索引.md）**:
```markdown
# 广告业务流程

> 来源文件: 广告业务流程-创建.xlsm
> 转换时间: 2026-01-21
> Sheet总数: 27

## Sheet列表

| 序号 | Sheet名称        | 状态     | 链接                           |
| ---- | ---------------- | -------- | ------------------------------ |
| 1    | 创建流程图       | 正常     | [查看](01_创建流程图.md)       |
| 2    | 广告创建涉及字段 | 正常     | [查看](02_广告创建涉及字段.md) |
| 15   | 配置数据         | **隐藏** | [查看](15_配置数据_隐藏.md)    |
```

---

### 场景6：流程图图片识别（Agent处理）

> [!IMPORTANT]
> 此场景由**Agent在阶段2处理**，不是脚本自动完成。

**描述**: 提取的图片是流程图，需要转换为Mermaid格式。

**处理方式**: 
1. Agent使用`view_file`工具查看图片
2. 分析图片中的节点、连线、文字
3. 生成对应的Mermaid代码
4. 更新MD文件，在图片引用后插入Mermaid代码块

**输出示例**:
```markdown
### 原始图片

![广告创建流程](images/创建流程图_image_1.png)

### Mermaid流程图

​```mermaid
flowchart LR
    用户((用户)) --> 创建请求[创建广告请求]
    创建请求 --> 创建广告[创建计广告]
    创建广告 --> 填写内容[填写内容]
    填写内容 --> 投放策略{投放策略}
    投放策略 --> |自动| 自动投放[自动投放]
    投放策略 --> |手动| 手动投放[手动投放]
    自动投放 --> 完成[完成设置]
    手动投放 --> 位置选择{投放位置}
    位置选择 --> |自动筛选| 筛选1[自动筛选]
    位置选择 --> |手动筛选| 筛选2[手动筛选]
​```
```

---

## Agent执行检查清单

当使用此技能时，Agent必须完成以下步骤：

### 阶段1：脚本执行
- [ ] 运行`convert_excel_to_md.py`脚本
- [ ] 记录脚本输出的图片总数（如：416张图片）

### 阶段2：图片识别（必须逐个处理）

> [!CAUTION]
> **每个MD文件可能包含多张图片，必须逐一处理，不能遗漏！**

对于每个MD文件：
1. **统计该文件引用的图片数量**
   - 使用`grep_search`搜索 `![` 或 `images/` 关键词
   - 记录图片数量，例如：`01_创建流程图.md` 包含 2 张图片

2. **逐一查看每张图片**
   - 对于 `xxx_image_1.png`，使用 `view_file` 查看
   - 对于 `xxx_image_2.png`，使用 `view_file` 查看
   - ... 直到所有图片都已查看

3. **判断每张图片类型并处理**
   - 流程图 → 生成Mermaid代码
   - 界面截图 → 添加操作说明
   - 数据表格 → 转换为Markdown表格

4. **更新MD文件**
   - 在**每张**图片引用下方添加对应的识别结果
   - 确保图片数量与识别结果数量一致

### 阶段2完成验证
- [ ] 已处理的图片数 = 文件中引用的图片数
- [ ] 每张流程图都有对应的Mermaid代码
- [ ] 最终检查：无遗漏图片

---

## 输出规范

### 文件命名
遵循`filename-rules.md`:
- 中文名称（特定术语除外）
- 添加版本后缀: `xxx_v1.0.md`
- 隐藏Sheet添加: `_隐藏` 后缀

### 表格格式
遵循`mdtable-rules.md`:
- 无合并单元格: 使用标准Markdown表格
- 有合并单元格: 使用HTML表格，代码紧凑无空行
- 单元格内图片: 使用 `![alt](path)` 或 `<img>` 标签

### 输出目录
遵循`direction-rules.md`:
- 输出到`output_LLM/`路径下

---

## 依赖

- Python 3.x
- openpyxl (`pip install openpyxl`)

---

## 版本历史

| 版本 | 日期       | 说明                                                     |
| ---- | ---------- | -------------------------------------------------------- |
| v1.2 | 2026-01-21 | 明确两阶段工作流程：脚本提取+Agent识别，添加执行检查清单 |
| v1.1 | 2026-01-21 | 增加特殊场景处理、输出示例、多Sheet分文件、隐藏Sheet标识 |
| v1.0 | 2026-01-21 | 初始版本，支持Excel转MD、合并单元格、图片提取            |
