# 库存域完整梳理文档	

> **数据域**: 库存域 (inv)	
> **优先级**: P1（重要域）	
> **版本**: v2.0	
> **创建日期**: 2026-01-19	
> **负责人**: 王苗苗	
> **分析部门**: 流通分析	

---

## 1. 域定义与业务全景	

### 1.1 域定义	

库存域覆盖**所有仓库类型**（自有仓 + FBA仓）的库存全生命周期管理，包括入库、库存状态、库龄分析、出库、库存损耗等。	

### 1.2 业务范围	

```
库存域核心：货物在仓库中的存储状态与流动轨迹
├── 自有仓库存（国内工厂仓/备货仓）
│   ├── 采购入库、生产入库
│   ├── 库存盘点、库龄监控
│   └── 销售出库、FBA补货出库
└── FBA仓库存（亚马逊海外仓）
    ├── FBA入仓（是入库的一种类型）
    ├── FBA库存、FBA库龄
    └── FBA代发货出库、库存移除
```

### 1.3 与履约域的边界澄清	

| 业务事件 | 库存域职责 | 履约域职责 |
|----------|-----------|-----------|
| 国内仓→FBA仓 | 记录出库（自有仓）+ 入库（FBA仓） | 头程运输过程跟踪 |
| FBA代发货 | 记录出库（FBA仓） | 尾程配送、签收跟踪 |
| 退货返仓 | 记录入库（目标仓） | 退货物流处理 |

> **关键澄清**：FBA入仓从库存视角是**入库的一种类型**，入的是FBA仓库；从物流视角属于履约域的头程运输完成事件。	

---

## 2. 业务流程图	

```mermaid
flowchart TB
    subgraph 自有仓["🏭 自有仓库存管理"]
        direction TB
        A1[采购到货] --> B[自有仓入库]
        A2[生产完工] --> B
        A3[退货返仓] --> B
        B --> C[自有仓库存]
        C --> D[库龄监控]
        D --> E{库存去向}
        E -->|销售| F[销售出库]
        E -->|FBA补货| G[FBA补货出库]
        E -->|滞销| H[损耗处理]
    end
    
    subgraph FBA仓["📦 FBA仓库存管理"]
        direction TB
        G --> I[头程运输]
        I --> J[FBA入仓]
        J --> K[FBA库存]
        K --> L[FBA库龄]
        L --> M{库存去向}
        M -->|销售| N[FBA代发货]
        M -->|库龄超期| O[库存移除/损耗]
    end
    
    style B fill:#c8e6c9
    style J fill:#bbdefb
    style C fill:#fff3e0
    style K fill:#e3f2fd
```

---

## 3. 业务过程定义	

### 3.1 业务流程→业务过程映射	

> **推导逻辑**：业务流程中的每个**可度量的关键事件节点**成为一个业务过程	

| 业务流程阶段 | 业务过程 | 英文名称 | 为什么是业务过程 |
|-------------|---------|----------|------------------|
| 入库管理 | 商品入库 | stock_in | 入库是一个可度量事件，有明确的时间点和数量 |
| 入库管理 | FBA入仓 | fba_inbound | FBA入仓是入库的特殊类型，有独特的属性（ShipmentID等） |
| 库存监控 | 库存盘点 | stock_check | 周期性快照，记录某时点的库存状态 |
| 库存监控 | 库龄分析 | inventory_aging | 周期性快照，记录库龄分布 |
| 出库管理 | 商品出库 | stock_out | 出库是一个可度量事件，有明确的时间点和数量 |
| 损耗管理 | 库存损耗 | stock_loss | 损耗是一个可度量事件，需要记录原因和金额 |

### 3.2 业务过程详细定义	

<table>
    <thead>
        <tr>
            <th>序号</th>
            <th>业务过程</th>
            <th>英文名称</th>
            <th>描述</th>
            <th>事实表类型</th>
            <th>粒度声明</th>
            <th>主键组成</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>1</td>
            <td>商品入库</td>
            <td>stock_in</td>
            <td>商品入库到仓库（自有仓）</td>
            <td>事务事实</td>
            <td>每一行代表一次入库单明细</td>
            <td>入库单号 + 行号</td>
        </tr>
        <tr>
            <td>2</td>
            <td>FBA入仓</td>
            <td>fba_inbound</td>
            <td>商品入库到FBA仓库</td>
            <td>事务事实</td>
            <td>每一行代表一个FBA入仓计划中的一个SKU</td>
            <td>ShipmentID + SKU</td>
        </tr>
        <tr>
            <td>3</td>
            <td>商品出库</td>
            <td>stock_out</td>
            <td>商品从仓库出库</td>
            <td>事务事实</td>
            <td>每一行代表一次出库单明细</td>
            <td>出库单号 + 行号</td>
        </tr>
        <tr>
            <td>4</td>
            <td>库存盘点</td>
            <td>stock_check</td>
            <td>定期盘点库存状态</td>
            <td>周期快照</td>
            <td>每一行代表某仓库某商品某天的库存快照</td>
            <td>仓库ID + SKU + 日期</td>
        </tr>
        <tr>
            <td>5</td>
            <td>库龄分析</td>
            <td>inventory_aging</td>
            <td>分析库存周转和库龄分布</td>
            <td>周期快照</td>
            <td>每一行代表某仓库某商品某天的库龄分布</td>
            <td>仓库ID + SKU + 日期</td>
        </tr>
        <tr>
            <td>6</td>
            <td>库存损耗</td>
            <td>stock_loss</td>
            <td>记录库存损耗</td>
            <td>事务事实</td>
            <td>每一行代表一笔库存损耗记录</td>
            <td>损耗单号 + 行号</td>
        </tr>
    </tbody>
</table>

---

## 4. 维度设计	

### 4.1 维度推导逻辑	

> **推导原则**：维度来源于回答"谁/什么/何时/何地/为何"等分析问题	

| 分析问题 | 对应维度 | 维度类型 |
|----------|---------|----------|
| 什么时候入库/出库？ | 时间维度 | 公共维度 |
| 什么商品？ | 产品维度 | 公共维度 |
| 哪个仓库？ | 仓库维度 | 公共维度 |
| 什么类型的仓库？ | 仓库类型维度 | 专属维度 |
| 库存状态如何？ | 库存状态维度 | 专属维度 |
| 库龄多长？ | 库龄区间维度 | 专属维度 |
| 入库来源是什么？ | 入库类型维度 | 专属维度 |
| 损耗原因是什么？ | 损耗原因维度 | 专属维度 |

### 4.2 维度清单	

#### 公共维度	

| 维度 | 英文名称 | 使用场景 |
|------|----------|----------|
| ✓ 时间维度 | dim_date | 所有业务过程 |
| ✓ 产品维度 | dim_product | 所有业务过程 |
| ✓ 变体维度 | dim_variant | 变体级库存管理 |
| ✓ 仓库维度 | dim_warehouse | 所有业务过程 |
| ✓ 供应商维度 | dim_supplier | 采购入库 |

#### 专属维度	

| 编号 | 维度名称 | 英文名称 | 主键 | 说明 |
|------|----------|----------|------|------|
| DIM-17 | 库龄区间维度 | dim_inventory_age | age_bucket_key | 0-30天、31-60天、61-90天、91-180天、181-270天、271+天 |
| DIM-18 | 库存状态维度 | dim_inventory_status | inv_status_key | 可售、不可售、预留、在途 |
| DIM-19 | 仓库类型维度 | dim_warehouse_type | warehouse_type_key | 自有仓、FBA仓、第三方仓 |
| DIM-20 | 入库类型维度 | dim_inbound_type | inbound_type_key | 采购入库、生产入库、FBA入仓、退货返仓 |
| DIM-21 | 损耗原因维度 | dim_loss_reason | loss_reason_key | 库龄超期、破损、丢失、盘亏 |

---

## 5. 事实表设计	

### 5.1 事实表清单	

| 编号 | 事实表名称 | 英文表名 | 类型 | 更新频率 | 说明 |
|------|-----------|----------|------|----------|------|
| FCT-10 | 入库事实表 | fct_inv_stock_in | 事务事实 | 日 | 记录每笔入库事件（含FBA入仓） |
| FCT-11 | 出库事实表 | fct_inv_stock_out | 事务事实 | 日 | 记录每笔出库事件 |
| FCT-12 | 库存日快照表 | fct_inv_stock_daily | 周期快照 | 日 | 每日库存余额快照 |
| FCT-13 | 库龄日快照表 | fct_inv_aging_daily | 周期快照 | 日 | 每日库龄分布快照 |
| FCT-14 | 损耗事实表 | fct_inv_stock_loss | 事务事实 | 日 | 记录每笔损耗事件 |

### 5.2 度量指标	

| 指标名称 | 指标说明 | 聚合方式 | 来源事实表 |
|----------|----------|----------|-----------|
| 入库数量 | 入库商品总数 | SUM | fct_inv_stock_in |
| 入库金额 | 入库商品总金额 | SUM | fct_inv_stock_in |
| 出库数量 | 出库商品总数 | SUM | fct_inv_stock_out |
| 出库金额 | 出库商品总金额 | SUM | fct_inv_stock_out |
| 库存数量 | 期末库存数量（半可加） | SUM | fct_inv_stock_daily |
| 库存金额 | 期末库存金额（半可加） | SUM | fct_inv_stock_daily |
| 库龄天数 | 平均库龄天数 | AVG | fct_inv_aging_daily |
| 滞销率 | 滞销商品占比 | AVG | fct_inv_aging_daily |
| 损耗数量 | 损耗商品总数 | SUM | fct_inv_stock_loss |
| 损耗金额 | 损耗商品总金额 | SUM | fct_inv_stock_loss |

---

## 6. 总线矩阵	

### 6.1 总线矩阵推导逻辑	

> **推导过程**：对每个业务过程，判断哪些维度可以用于分析	

```
业务过程 + 维度 = 分析视角
例如：入库 + 时间 = 按时间分析入库趋势
      入库 + 仓库类型 = 按仓库类型分析入库分布
```

### 6.2 库存域总线矩阵	

| 业务过程 | 时间 | 产品 | 仓库 | 仓库类型 | 库存状态 | 库龄区间 | 入库类型 | 损耗原因 | 供应商 |
|----------|------|------|------|----------|----------|----------|----------|----------|--------|
| 商品入库 | ✓ | ✓ | ✓ | ✓ | | | ✓ | | ✓ |
| FBA入仓 | ✓ | ✓ | ✓ | ✓ | | | ✓ | | |
| 商品出库 | ✓ | ✓ | ✓ | ✓ | | | | | |
| 库存盘点 | ✓ | ✓ | ✓ | ✓ | ✓ | | | | |
| 库龄分析 | ✓ | ✓ | ✓ | ✓ | | ✓ | | | |
| 库存损耗 | ✓ | ✓ | ✓ | ✓ | | | | ✓ | |

### 6.3 总线矩阵解读	

- **时间维度**：所有业务过程都需要按时间分析趋势	
- **产品维度**：所有业务过程都需要知道是什么商品	
- **仓库类型维度**：区分自有仓和FBA仓的关键维度	
- **库存状态维度**：仅用于库存盘点，区分可售/不可售	
- **库龄区间维度**：仅用于库龄分析，划分库龄区间	
- **入库类型维度**：仅用于入库，区分入库来源	
- **损耗原因维度**：仅用于损耗，分析损耗原因	

---

## 7. 跨域关联说明	

### 7.1 与履约域的关联	

| 库存域事件 | 关联履约域事件 | 关联方式 |
|-----------|---------------|----------|
| FBA补货出库 | 头程运输发货 | 同一批货物 |
| FBA入仓 | 头程运输签收 | ShipmentID 关联 |
| 退货入库 | 处理退货完成 | 退货单号关联 |

### 7.2 与交易域的关联	

| 库存域事件 | 关联交易域事件 | 关联方式 |
|-----------|---------------|----------|
| 销售出库 | 订单发货 | 订单号关联 |
| FBA代发货 | 订单签收 | 订单号关联 |

---

## 更新记录	

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| v1.0 | 2026-01-19 | 初始版本，整合业务流程、业务过程、维度、指标、总线矩阵设计 |
